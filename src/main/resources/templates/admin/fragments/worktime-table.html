<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="table">
    <form th:action="@{/admin/worktime/update}" method="post">
        <input type="hidden" name="year" th:value="${currentYear}">
        <input type="hidden" name="month" th:value="${currentMonth}">

        <!-- Calculate days in month dynamically -->
        <div th:with="daysInMonth=${T(java.time.YearMonth).of(currentYear, currentMonth).lengthOfMonth()}"
             class="table-responsive">
            <div class="worktime-table-wrapper">
                <table class="table table-bordered worktime-table mb-0">
                    <!-- Table Header -->
                    <thead>
                    <tr>
                        <th class="table-light sticky-col employee-col">Employee</th>
                        <th class="table-light sticky-col id-col">ID</th>

                        <!-- Day Headers with Weekend Check -->
                        <th th:each="day : ${#numbers.sequence(1, daysInMonth)}"
                            th:with="date=${T(java.time.LocalDate).of(currentYear, currentMonth, day)},
                                         isWeekend=${date.dayOfWeek.value >= 6}"
                            th:class="${'table-light text-center day-col ' + (isWeekend ? 'weekend-day' : '')}"
                            scope="col">
                            <div class="day-header">
                                <div class="day-number" th:text="${day}"></div>
                                <div class="day-initial"
                                     th:text="${#temporals.format(date, 'E').substring(0,1)}">
                                </div>
                            </div>
                        </th>

                        <!-- Summary Headers -->
                        <th class="table-light text-center summary-col">Reg</th>
                        <th class="table-light text-center summary-col">OT</th>
                        <th class="table-light text-center summary-col">Tot</th>
                        <th class="table-light text-center summary-col">Days</th>
                        <th class="table-light text-center summary-col">Off</th>
                        <th class="table-light text-center action-col"></th>
                    </tr>
                    </thead>

                    <!-- Table Body -->
                    <tbody>
                    <tr th:each="user : ${users}"
                        th:if="${!user.hasRole('ROLE_ADMIN')}"
                        th:class="${user.userId == selectedUserId ? 'selected-user' : ''}">

                        <!-- Employee Info -->
                        <td class="sticky-col employee-col">
                            <a class="employee-link"
                               th:href="@{/admin/worktime(year=${currentYear},month=${currentMonth},selectedUserId=${user.userId})}">
                                <span th:text="${user.name}">Employee Name</span>
                            </a>
                        </td>
                        <td class="sticky-col id-col" th:text="${user.employeeId}"></td>

                        <!-- Day Entry Cells with Weekend Check -->
                        <td th:each="day : ${#numbers.sequence(1, daysInMonth)}"
                            th:with="date=${T(java.time.LocalDate).of(currentYear, currentMonth, day)},
                                     isWeekend=${date.dayOfWeek.value >= 6},
                                     entry=${userEntriesMap.get(user.userId)?.get(date)}"
                            th:class="${'worktime-cell ' + (isWeekend ? 'weekend-cell ' : '') +
                                     (entry != null ?
                                     ((entry.adminSync == 'ADMIN_EDITED' ? 'admin-edit ' : '') +
                                     (entry.adminSync == 'USER_INPUT' ? 'user-input ' : '') +
                                     (entry.adminSync == 'USER_DONE' ? 'user-synced ' : '') +
                                     (entry.adminSync == 'ADMIN_BLANK' ? 'blank-entry ' : '') +
                                     (entry.adminSync == 'USER_IN_PROCESS' ? 'in-process ' : '') +
                                     (entry.timeOffType == 'SN' ? 'holiday ' : '') +
                                     (entry.timeOffType == 'CO' ? 'vacation ' : '') +
                                     (entry.timeOffType == 'CM' ? 'medical ' : '')) : '')}">
                            <input type="text"
                                   class="worktime-input"
                                   th:name="|entries[${user.userId}].days[${day}]|"
                                   th:value="${entry != null ?
                                             (entry.adminSync == 'ADMIN_BLANK' ? '' :
                                              entry.adminSync == 'USER_IN_PROCESS' ? '' :  <!-- Don't show value for in-process -->
                                             (entry.timeOffType != null ? entry.timeOffType :
                                             (entry.totalWorkedMinutes != null ? T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHH(entry.totalWorkedMinutes) : '')))
                                             : ''}"
                                   pattern="^([1-9]|1\d|2[0-4]|SN|CO|CM)?$"
                                   title="Enter hours (1-24) or SN/CO/CM"
                                   maxlength="2">
                        </td>

                        <!-- Summary Cells -->
                        <td class="text-center summary-col" th:with="summary=${userSummaries.get(user.userId)}"
                            th:text="${summary != null ? T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHH(summary.totalRegularMinutes) : '0'}">
                        </td>
                        <td class="text-center summary-col" th:with="summary=${userSummaries.get(user.userId)}"
                            th:text="${summary != null ? T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHH(summary.totalOvertimeMinutes) : '0'}">
                        </td>
                        <td class="text-center summary-col" th:with="summary=${userSummaries.get(user.userId)}"
                            th:text="${summary != null ? T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHH(summary.totalMinutes) : '0'}">
                        </td>
                        <td class="text-center summary-col" th:with="summary=${userSummaries.get(user.userId)}"
                            th:text="${summary?.daysWorked ?: 0}">
                        </td>
                        <td class="text-center summary-col" th:with="summary=${userSummaries.get(user.userId)}"
                            th:text="${summary != null ? summary.snDays + '-' + summary.coDays + '-' + summary.cmDays : '0-0-0'}">
                        </td>
                        <td class="text-center action-col">
                            <button type="submit"
                                    name="userId"
                                    th:value="${user.userId}"
                                    class="btn btn-sm btn-primary">
                                <i class="bi bi-save"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </form>

    <style>
        .worktime-table-wrapper {
            overflow-x: auto;
            position: relative;
        }

        .weekend-day, .weekend-cell {
            background-color: #f8f9fa !important;
        }

           /* Input in weekend cells */
        .weekend-cell .worktime-input {
            background-color: #f8f9fa;
        }

        .worktime-table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
        }

        /* Column Sizes */
        .sticky-col {
            position: sticky;
            background: white;
            z-index: 10;
        }

        .employee-col {
            left: 0;
            min-width: 80px;
            max-width: 80px;
        }

        .id-col {
            left: 160px;
            width: 60px;
            max-width: 60px;
        }

        .day-col {
            width: 40px;
            max-width: 40px;
            padding: 2px !important;
        }

        .summary-col {
            width: 60px;
            max-width: 60px;
            padding: 4px !important;
        }

        .in-process {
            background-color: #e9ecef !important; /* Light gray background */
        }

        .in-process .worktime-input {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .blank-entry {
            background-color: #ffffff !important;  /* or any color you prefer */
        }

        .blank-entry .worktime-input {
            background-color: #ffffff;
        }

        .action-col {
            width: 40px;
            max-width: 40px;
            padding: 4px !important;
        }

        /* Header Styles */
        .day-header {
            font-size: 0.75rem;
            line-height: 1;
            text-align: center;
        }

        .day-number {
            font-weight: 600;
        }

        .day-initial {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .weekend-day {
            background-color: #f8f9fa;
        }

        /* Input Styles */
        .worktime-input {
            width: 100%;
            height: 24px;
            padding: 2px;
            text-align: center;
            border: 1px solid transparent;
            font-size: 0.75rem;
        }

        .worktime-input:focus {
            outline: none;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25);
        }

        /* Status Colors */
        .admin-edit { background-color: #fff3cd !important; } /* Admin Edited - Yellow */
        .user-input { background-color: #d1e7dd !important; } /* User Input - Green */
        .user-synced { background-color: #e2e3e5 !important; } /* Synced - Gray */

        /* Time Off Colors */
        .holiday { background-color: #f8d7da !important; } /* SN - Light Red */
        .vacation { background-color: #cff4fc !important; } /* CO - Light Blue */
        .medical { background-color: #fff3cd !important; } /* CM - Light Yellow */

        /* Employee Link */
        .employee-link {
            color: inherit;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .employee-link:hover {
            color: #0d6efd;
        }

        /* Selected User */
        .selected-user {
            background-color: rgba(13, 110, 253, 0.05);
        }

        /* Table Cell Text */
        td {
            font-size: 0.75rem;
            padding: 4px !important;
            vertical-align: middle;
        }

        /* Save Button */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    </style>
</div>
</body>
</html>