<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}" lang="en">
<head>
    <title>Work Time Management</title>
    <link rel="stylesheet" th:href="@{/css/worktime-admin.css?v=081120251622}">
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid py-4">
        <!-- Header Section -->
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <h1 class="header-title">
                    <i class="bi bi-clock-history me-2"></i>Work Time Management
                </h1>
                <div class="badge bg-primary rounded-pill">
                    <i class="bi bi-shield me-2"></i>Admin Panel
                </div>
            </div>
            <a class="btn btn-outline-primary" th:href="@{/admin}">
                <i class="bi bi-grid me-2"></i>Dashboard
            </a>
        </div>

        <!-- Management Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Period Management & Holidays</h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- Period Selection -->
                    <div class="col-md-6">
                        <h6 class="d-flex align-items-center mb-3">
                            <i class="bi bi-calendar3 me-2"></i>View Period
                        </h6>
                        <form th:action="@{/admin/worktime/view-period}" method="post" class="d-flex gap-3">
                            <div class="form-group">
                                <label for="yearSelect" class="visually-hidden">Year</label>
                                <select id="yearSelect" name="year" class="form-select" style="width: 120px" required>
                                    <option th:each="yr : ${#numbers.sequence(2020, 2030)}"
                                            th:value="${yr}"
                                            th:text="${yr}"
                                            th:selected="${yr == currentYear}">
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="monthSelect" class="visually-hidden">Month</label>
                                <select id="monthSelect" name="month" class="form-select" style="width: 140px" required>
                                    <option th:each="monthEntry : ${T(java.time.Month).values()}"
                                            th:value="${monthEntry.getValue()}"
                                            th:text="${monthEntry.name()}"
                                            th:selected="${monthEntry.getValue() == currentMonth}">
                                    </option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">View Period</button>
                        </form>
                    </div>

                    <!-- Holiday Management - Show only when period is loaded -->
                    <div class="col-md-6" th:unless="${showBlankTable}">
                        <h6 class="d-flex align-items-center mb-3">
                            <i class="bi bi-calendar-event me-2"></i>Add National Holiday
                        </h6>
                        <form th:action="@{/admin/worktime/holiday/add}" method="post" class="d-flex gap-3">
                            <div class="form-group">
                                <label for="daySelect" class="visually-hidden">Day</label>
                                <select id="daySelect" name="day" class="form-select" required style="width: 120px">
                                    <option value="">Select Day</option>
                                    <option th:each="day : ${#numbers.sequence(1, daysInMonth)}"
                                            th:value="${day}"
                                            th:text="${day}">
                                    </option>
                                </select>
                            </div>
                            <input type="hidden" name="year" th:value="${currentYear}">
                            <input type="hidden" name="month" th:value="${currentMonth}">
                            <button type="submit" class="btn btn-primary">Add Holiday</button>
                        </form>
                    </div>
                    <!-- NEW: Finalize Management (show only when period loaded) -->
                    <div class="col-md-4" th:unless="${showBlankTable}">
                        <h6 class="d-flex align-items-center mb-3">
                            <i class="bi bi-check-circle me-2 text-danger"></i>Finalize Period
                        </h6>
                        <div class="d-flex flex-column gap-2">
                            <!-- Finalize All Button -->
                            <button type="button"
                                    class="btn btn-danger btn-sm"
                                    onclick="showFinalizeConfirmation(null)"
                                    title="Finalize all users for this period">
                                <i class="bi bi-lock-fill me-1"></i>Finalize All Users
                            </button>

                            <!-- User-Specific Finalize -->
                            <div class="input-group input-group-sm">
                                <label for="finalizeUserSelect"></label><select id="finalizeUserSelect" class="form-select form-select-sm">
                                    <option value="">Select specific user...</option>
                                    <option th:each="user : ${users}"
                                            th:value="${user.userId}"
                                            th:text="${user.name}">
                                        User Name
                                    </option>
                                </select>
                                <button type="button"
                                        class="btn btn-warning btn-sm"
                                        onclick="finalizeSpecificUser()"
                                        title="Finalize selected user only">
                                    <i class="bi bi-person-lock me-1"></i>Finalize User
                                </button>
                            </div>

                            <!-- Info Text -->
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Finalized entries cannot be modified
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Finalization Confirmation Modal -->
        <div class="modal fade" id="finalizeConfirmationModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>Confirm Finalization
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>WARNING:</strong> This action cannot be undone!
                        </div>
                        <p id="finalizeModalText">
                            You are about to finalize worktime entries. Once finalized, entries cannot be modified.
                        </p>
                        <div id="finalizeDetails" class="bg-light p-3 rounded">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="executeFinalization()">
                            <i class="bi bi-lock-fill me-1"></i>Yes, Finalize
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Finalization Progress Modal -->
        <div class="modal fade" id="finalizationProgressModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-body text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <h6>Finalizing Worktime Entries</h6>
                        <p class="text-muted mb-0">Please wait...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- BLANK STATE: Show when no period selected -->
        <div th:if="${showBlankTable}" class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Employee Records</h5>
            </div>
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-calendar3 text-muted" style="font-size: 3rem;"></i>
                </div>
                <h5 class="text-muted mb-3">No Period Selected</h5>
                <p class="text-muted mb-0">Select a year and month above, then click <strong>"View Period"</strong> to
                    load and consolidate worktime data.</p>
            </div>
        </div>

        <!-- WORKTIME TABLE: Show only when period is loaded -->
        <div th:unless="${showBlankTable}" class="card shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="card-title mb-0">Employee Records</h5>
                        <span class="badge bg-light text-dark border">
                            [[${T(java.time.Month).of(currentMonth)}]] [[${currentYear}]]
                        </span>
                    </div>
                    <a th:href="@{/admin/worktime/export(year=${currentYear},month=${currentMonth})}"
                       class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-excel me-1"></i>Export to Excel
                    </a>
                </div>
            </div>

            <!-- Work Time Table -->
            <div class="table-responsive" style="max-height: calc(100vh - 250px);">
                <table class="table table-bordered table-hover mb-0 worktime-table">
                    <thead class="bg-light">
                    <tr>
                        <th class="align-middle">Name</th>
                        <th class="align-middle">ID</th>
                        <!-- Days Headers -->
                        <th th:each="header : ${dayHeaders}"
                            class="day-column align-middle"
                            th:classappend="${header.isWeekend == 'true'} ? 'weekend'">
                            <div class="day-header">
                                <div class="day-initial" th:text="${header.initial}">Mon</div>
                                <div class="day-number" th:text="${header.day}">1</div>
                            </div>
                        </th>
                        <!-- Summary Headers -->
                        <th class="text-center align-middle summary-col">Reg.Hrs</th>
                        <th class="text-center align-middle summary-col">OT</th>
                        <th class="text-center align-middle summary-col">Days</th>
                        <th class="text-center align-middle summary-col">Off</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="user : ${users}">
                        <td th:text="${user.name}">John Doe</td>
                        <td th:text="${user.employeeId}" class="text-monospace">EMP001</td>

                        <!-- FIXED: Day Cells using Display DTOs with CLEAN CSS SEPARATION -->
                        <td th:each="day : ${#numbers.sequence(1, daysInMonth)}"
                            class="text-center align-middle worktime-cell"
                            th:with="date=${T(java.time.LocalDate).of(currentYear, currentMonth, day)},
                                     displayDTO=${userDisplayDTOs.get(user.userId)?.get(date)},
                                     rawEntry=${userEntriesMap.get(user.userId)?.get(date)}"
                            th:classappend="${displayDTO?.isWeekend ? 'weekend' : ''}"
                            th:attr="data-user-id=${user.userId},
                                     data-date=${displayDTO?.dateString},
                                     title=${displayDTO?.tooltipText}"
                            onclick="showEditor(this)">

                            <!-- FIXED: Simple and clean - just apply DTO CSS class to span -->
                            <span th:if="${displayDTO?.hasEntry && !#strings.isEmpty(displayDTO?.cssClass)}"
                                  th:class="${displayDTO?.cssClass}"
                                  th:text="${displayDTO?.displayText}">SN</span>

                            <!-- Regular work entries and entries without special CSS -->
                            <span th:if="${displayDTO?.hasEntry && #strings.isEmpty(displayDTO?.cssClass)}"
                                  th:text="${displayDTO?.displayText}">8</span>

                            <!-- Empty cell (no entry) -->
                            <span th:unless="${displayDTO?.hasEntry}">-</span>
                            <!-- Editor popup for each cell -->
                            <div class="worktime-editor">
                                <h6 class="mb-2">Edit Time Entry</h6>
                                <div class="quick-actions d-flex gap-2 flex-wrap mb-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="setWorktime(this, '8')" title="8 hours work">8h</button>
                                    <button class="btn btn-sm btn-outline-success" onclick="setWorktime(this, 'SN')" title="Holiday (no work)">SN</button>
                                    <button class="btn btn-sm btn-outline-info" onclick="setWorktime(this, 'CO')" title="Vacation">CO</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="setWorktime(this, 'CM')" title="Medical">CM</button>
                                    <button class="btn btn-sm" onclick="setWorktime(this, 'CR')" title="Recovery Leave (paid from overtime)" style="background-color: #198754; color: white; border-color: #198754;">CR</button>
                                    <button class="btn btn-sm" onclick="setWorktime(this, 'CN')" title="Unpaid Leave" style="background-color: #6c757d; color: white; border-color: #6c757d;">CN</button>
                                    <button class="btn btn-sm" onclick="setWorktime(this, 'D')" title="Delegation (business trip)" style="background-color: #0d6efd; color: white; border-color: #0d6efd;">D</button>
                                    <button class="btn btn-sm" onclick="setWorktime(this, 'CE')" title="Event Leave (marriage/birth/death)" style="background-color: #d63384; color: white; border-color: #d63384;">CE</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="setWorktime(this, 'REMOVE')" title="Remove entry">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="input-group mb-2">
                                    <label>
                                        <input type="text" class="form-control form-control-sm"
                                               placeholder="Custom entry">
                                    </label>
                                    <button class="btn btn-sm btn-primary" onclick="saveWorktime(this)">Save</button>
                                </div>

                                <!-- ENHANCED: Dynamic Entry Information (uses rawEntry for detailed info) -->
                                <div class="entry-info">
                                    <div class="current-entry-info">
                                        <small class="text-primary fw-bold d-block mb-1">Current Entry:</small>
                                        <div class="entry-details">
                                            <!-- This will be populated dynamically by JavaScript using rawEntry data -->
                                            <small class="text-muted d-block entry-loading">
                                                <i class="bi bi-hourglass-split entry-icon"></i>Loading entry details...
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>


                        <!-- Summary Columns -->
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHHmm(summary?.totalRegularMinutes ?: 0)}">00:00</span>
                        </td>
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHHmm(summary?.totalOvertimeMinutes ?: 0)}">00:00</span>
                        </td>
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${summary?.daysWorked ?: 0}">0</span>
                        </td>
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${summary?.totalTimeOffDays ?: 0}">0</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table Footer with Legend -->
            <div class="card-footer bg-light py-2">
                <div class="row">
                    <div class="col-md-10">
                        <small class="text-muted">
                            <strong>Legend:</strong>
                            <span class="holiday me-2">SN</span> Holiday •
                            <span class="sn-work-display me-2">SN4</span> Holiday+Work •
                            <span class="vacation me-2">CO</span> Vacation •
                            <span class="co-work-display me-2">CO6</span> Vacation+Work •
                            <span class="medical me-2">CM</span> Medical •
                            <span class="cm-work-display me-2">CM4</span> Medical+Work •
                            <span class="weekend me-2">W</span> Weekend •
                            <span class="w-work-display me-2">W8</span> Weekend+Work •
                            <span class="cr-display me-2">CR</span> Recovery Leave •
                            <span class="cn-display me-2">CN</span> Unpaid Leave •
                            <span class="zs-display me-2">ZS-6</span> Short Day •
                            <span class="ce-display me-2">CE</span> Event Leave •
                            <span class="d-display me-2">D</span> Delegation
                        </small>
                    </div>
                    <div class="col-md-2 text-end">
                        <small class="text-muted">
                            <strong>Tip:</strong> Click any cell to edit
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Scripts -->
    <th:block layout:fragment="scripts">
        <!-- ES6 Module (Modern Browsers) with cache busting -->
        <script type="module">
            const cacheBuster = new Date().getTime();
            import(`/js/features/worktime/admin/index.js?v=081120251622${cacheBuster}`)
                .then(() => console.log('✅ Admin Worktime - ES6 module loaded'))
                .catch(err => console.error('❌ Error loading admin worktime module:', err));
        </script>

        <!-- Legacy Fallback (IE11) -->
        <script nomodule th:src="@{/js/legacy/worktime-admin.js?v=081120251622}"></script>
        <script nomodule>
            console.log('⚠️ Admin Worktime - Legacy fallback loaded');
        </script>
    </th:block>
</div>
</body>
</html>