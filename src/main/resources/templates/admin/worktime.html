<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}" lang="en">
<head>
    <title>Work Time Management</title>
    <link rel="stylesheet" th:href="@{/css/worktime-admin.css?v=18790}">
    <link rel="stylesheet" th:href="@{/css/alerts.css?v=18781}">
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid py-4">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <h1 class="h2 mb-0">Work Time Management</h1>
                <div class="badge bg-primary rounded-pill px-3 py-2">Admin Panel</div>
            </div>
            <a th:href="@{/admin}" class="btn btn-outline-primary">
                <i class="bi bi-grid"></i> Dashboard
            </a>
        </div>

        <!-- Alert System -->
        <div class="mb-4" th:replace="~{alerts/alerts :: alerts}"></div>

        <!-- Management Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Period Management & Holidays</h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- Period Selection -->
                    <div class="col-md-6">
                        <h6 class="d-flex align-items-center mb-3">
                            <i class="bi bi-calendar3 me-2"></i>View Period
                        </h6>
                        <form th:action="@{/admin/worktime/view-period}" method="post" class="d-flex gap-3">
                            <div class="form-group">
                                <label for="yearSelect" class="visually-hidden">Year</label>
                                <select id="yearSelect" name="year" class="form-select" style="width: 120px" required>
                                    <option th:each="yr : ${#numbers.sequence(2020, 2030)}"
                                            th:value="${yr}"
                                            th:text="${yr}"
                                            th:selected="${yr == currentYear}">
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="monthSelect" class="visually-hidden">Month</label>
                                <select id="monthSelect" name="month" class="form-select" style="width: 140px" required>
                                    <option th:each="monthEntry : ${T(java.time.Month).values()}"
                                            th:value="${monthEntry.getValue()}"
                                            th:text="${monthEntry.name()}"
                                            th:selected="${monthEntry.getValue() == currentMonth}">
                                    </option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">View Period</button>
                        </form>
                    </div>

                    <!-- Holiday Management - Show only when period is loaded -->
                    <div class="col-md-6" th:unless="${showBlankTable}">
                        <h6 class="d-flex align-items-center mb-3">
                            <i class="bi bi-calendar-event me-2"></i>Add National Holiday
                        </h6>
                        <form th:action="@{/admin/worktime/holiday/add}" method="post" class="d-flex gap-3">
                            <div class="form-group">
                                <label for="daySelect" class="visually-hidden">Day</label>
                                <select id="daySelect" name="day" class="form-select" required style="width: 120px">
                                    <option value="">Select Day</option>
                                    <option th:each="day : ${#numbers.sequence(1, daysInMonth)}"
                                            th:value="${day}"
                                            th:text="${day}">
                                    </option>
                                </select>
                            </div>
                            <input type="hidden" name="year" th:value="${currentYear}">
                            <input type="hidden" name="month" th:value="${currentMonth}">
                            <button type="submit" class="btn btn-primary">Add Holiday</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- BLANK STATE: Show when no period selected -->
        <div th:if="${showBlankTable}" class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Employee Records</h5>
            </div>
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-calendar3 text-muted" style="font-size: 3rem;"></i>
                </div>
                <h5 class="text-muted mb-3">No Period Selected</h5>
                <p class="text-muted mb-0">Select a year and month above, then click <strong>"View Period"</strong> to
                    load and consolidate worktime data.</p>
            </div>
        </div>

        <!-- WORKTIME TABLE: Show only when period is loaded -->
        <div th:unless="${showBlankTable}" class="card shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="card-title mb-0">Employee Records</h5>
                        <span class="badge bg-light text-dark border">
                            [[${T(java.time.Month).of(currentMonth)}]] [[${currentYear}]]
                        </span>
                    </div>
                    <a th:href="@{/admin/worktime/export(year=${currentYear},month=${currentMonth})}"
                       class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-excel me-1"></i>Export to Excel
                    </a>
                </div>
            </div>

            <!-- Work Time Table -->
            <div class="table-responsive" style="max-height: calc(100vh - 250px);">
                <table class="table table-bordered table-hover mb-0 worktime-table">
                    <thead class="bg-light">
                    <tr>
                        <th class="align-middle">Name</th>
                        <th class="align-middle">ID</th>
                        <!-- Days Headers -->
                        <th th:each="header : ${dayHeaders}"
                            class="day-column align-middle"
                            th:classappend="${header.isWeekend == 'true'} ? 'weekend'">
                            <div class="day-header">
                                <div class="day-initial" th:text="${header.initial}">Mon</div>
                                <div class="day-number" th:text="${header.day}">1</div>
                            </div>
                        </th>
                        <!-- Summary Headers -->
                        <th class="text-center align-middle summary-col">Reg.Hrs</th>
                        <th class="text-center align-middle summary-col">OT</th>
                        <th class="text-center align-middle summary-col">Days</th>
                        <th class="text-center align-middle summary-col">Off</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="user : ${users}">
                        <td th:text="${user.name}">John Doe</td>
                        <td th:text="${user.employeeId}" class="text-monospace">EMP001</td>

                        <!-- Day Cells -->
                        <td th:each="day : ${#numbers.sequence(1, daysInMonth)}"
                            class="text-center align-middle worktime-cell"
                            th:with="date=${T(java.time.LocalDate).of(currentYear, currentMonth, day)},
                             entry=${userEntriesMap.get(user.userId)?.get(date)}"
                            th:classappend="${dayHeaders[day-1].isWeekend == 'true'} ? 'weekend'"
                            th:attr="data-user-id=${user.userId},data-date=${currentYear + '-' + currentMonth + '-' + day}"
                            onclick="showEditor(this)">

                            <!-- NEW SIMPLIFIED DISPLAY LOGIC -->

                            <!-- SN with work hours: Red SN4 format -->
                            <span th:if="${entry?.timeOffType == 'SN' && entry?.totalOvertimeMinutes != null && entry.totalOvertimeMinutes > 0}"
                                  class="sn-work-display"
                                  th:text="'SN' + ${T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHH(entry.totalOvertimeMinutes).replace('h', '')}">SN4</span>

                            <!-- Regular SN (no work): Green SN -->
                            <span th:if="${entry?.timeOffType == 'SN' && (entry?.totalOvertimeMinutes == null || entry.totalOvertimeMinutes == 0)}"
                                  class="holiday"
                                  th:text="${entry.timeOffType}">SN</span>

                            <!-- CO (Vacation): Blue -->
                            <span th:if="${entry?.timeOffType == 'CO'}"
                                  class="vacation"
                                  th:text="${entry.timeOffType}">CO</span>

                            <!-- CM (Medical): Yellow -->
                            <span th:if="${entry?.timeOffType == 'CM'}"
                                  class="medical"
                                  th:text="${entry.timeOffType}">CM</span>

                            <!-- Regular work time (no time off) -->
                            <span th:if="${entry?.timeOffType == null && entry?.totalWorkedMinutes != null && entry?.adminSync != 'ADMIN_BLANK'}"
                                  th:text="${T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHH(entry.totalWorkedMinutes)}">8h</span>

                            <!-- Empty cell (no entry) -->
                            <span th:if="${entry == null || (entry?.timeOffType == null && (entry?.totalWorkedMinutes == null || entry?.adminSync == 'ADMIN_BLANK'))}">-</span>

                            <!-- Editor popup for each cell -->
                            <div class="worktime-editor">
                                <h6 class="mb-2">Edit Time Entry</h6>
                                <div class="quick-actions d-flex gap-2 mb-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="setWorktime(this, '8')" title="8 hours work">8h</button>
                                    <button class="btn btn-sm btn-outline-success" onclick="setWorktime(this, 'SN')" title="Holiday (no work)">SN</button>
                                    <button class="btn btn-sm btn-outline-info" onclick="setWorktime(this, 'CO')" title="Vacation">CO</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="setWorktime(this, 'CM')" title="Medical">CM</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="setWorktime(this, 'REMOVE')" title="Remove entry">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="input-group mb-2">
                                    <label>
                                        <input type="text" class="form-control form-control-sm"
                                               placeholder="Custom entry">
                                    </label>
                                    <button class="btn btn-sm btn-primary" onclick="saveWorktime(this)">Save</button>
                                </div>

                                <!-- ENHANCED: Dynamic Entry Information -->
                                <div class="entry-info">
                                    <div class="current-entry-info">
                                        <small class="text-primary fw-bold d-block mb-1">Current Entry:</small>
                                        <div class="entry-details">
                                            <!-- This will be populated dynamically by JavaScript -->
                                            <small class="text-muted d-block entry-loading">
                                                <i class="bi bi-hourglass-split entry-icon"></i>Loading entry details...
                                            </small>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </td>

                        <!-- Summary Columns -->
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHHmm(summary?.totalRegularMinutes ?: 0)}">00:00</span>
                        </td>
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${T(com.ctgraphdep.utils.CalculateWorkHoursUtil).minutesToHHmm(summary?.totalOvertimeMinutes ?: 0)}">00:00</span>
                        </td>
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${summary?.daysWorked ?: 0}">0</span>
                        </td>
                        <td class="summary-col text-center" th:with="summary=${userSummaries.get(user.userId)}">
                            <span th:text="${summary?.totalTimeOffDays ?: 0}">0</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table Footer with Legend -->
            <div class="card-footer bg-light py-2">
                <div class="row">
                    <div class="col-md-8">
                        <small class="text-muted">
                            <strong>Legend:</strong>
                            <span class="holiday me-2">SN</span> Holiday (Free Day) •
                            <span class="sn-work-display me-2">SN4</span> Holiday + Work •
                            <span class="vacation me-2">CO</span> Vacation •
                            <span class="medical me-2">CM</span> Medical
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">
                            <strong>Tip:</strong> Click any cell to edit worktime
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Scripts -->
    <th:block layout:fragment="scripts">
        <script th:src="@{/js/worktime-admin.js?v=18792}"></script>
    </th:block>
</div>
</body>
</html>