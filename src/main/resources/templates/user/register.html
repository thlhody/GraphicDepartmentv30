<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}"
      lang="en">
<head>
    <title>User Work Registry</title>
    <style>
        /* Register form styles */
        .register-form {
            transition: all 0.3s ease;
        }

        .register-form:hover {
            transform: translateY(-2px);
        }
        /* Set Select2 container height to match other inputs */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(1.5em + 0.5rem + 2px) !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Fix token/tag size */
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            padding: 2px 6px !important;
            margin: 2px !important;
            font-size: 0.875rem !important;
        }

        /* Adjust search box */
        .select2-container--bootstrap-5 .select2-search__field {
            margin-top: 2px !important;
            height: calc(1.5em + 0.25rem) !important;
        }

        /* Fix dropdown size */
        .select2-container--bootstrap-5 .select2-dropdown {
            font-size: 0.875rem !important;
        }

        /* Fix dropdown items padding */
        .select2-container--bootstrap-5 .select2-results__option {
            padding: 0.25rem 0.5rem !important;
        }

        /* Make select2 match form-select-sm */
        .select2-container--bootstrap-5.select2-container--form-select-sm .select2-selection {
            min-height: calc(1.5em + 0.5rem + 2px) !important;
            padding: 0.25rem 0.5rem !important;
            font-size: 0.875rem !important;
            border-radius: 0.25rem !important;
        }
        .form-control-sm {
            height: calc(1.5em + 0.5rem + 2px);
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Table styles */
        .table-actions {
            width: 100px;
        }

        .table-actions .btn {
            padding: 0.25rem 0.5rem;
        }

        /* Period selector */
        .period-selector {
            border-radius: 0.5rem;
            background: #f8f9fa;
        }

        .period-selector .btn-group {
            flex-wrap: wrap;
        }

        .period-selector .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Empty state */
        .empty-state {
            padding: 3rem 1.5rem;
            text-align: center;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* General Badge Style */
        .badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.875em;
            font-weight: 700;
            text-align: center;
            border-radius: 0.25rem;
            color: #fff;
        }

        /* Action-Specific Colors */
        .bg-order {
            background-color: #007bff; /* Blue */
        }

        .bg-reorder {
            background-color: #6c757d; /* Gray */
        }

        .bg-sample {
            background-color: #28a745; /* Green */
        }

        .bg-strikeoff {
            background-color: #ffc107; /* Yellow */
            color: #212529; /* Dark text for contrast */
        }

        .bg-designs {
            background-color: #dc3545; /* Red */
        }

        .bg-other {
            background-color: #6f42c1; /* Purple */
        }

        .bg-layout {
            background-color: #17a2b8; /* Teal */
        }
        /* Admin Sync Status Badges */
        .badge.bg-success {
            background-color: #198754 !important;
        }

        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .register-form .col-auto {
                width: 100% !important;
            }

            .table-responsive {
                margin: 0 -1rem;
            }

            .period-selector .btn-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<!-- Register Page Content -->
<div layout:fragment="content">
    <div class="container py-4">
        <!-- Alert System -->
        <div class="mb-4">
            <div th:replace="~{alerts/alerts :: alerts}"></div>
        </div>

        <!-- Header Section -->
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <h1 class="header-title">
                    <i class="bi bi-journal-text me-2"></i>Work Registry
                </h1>
                <div class="badge bg-primary rounded-pill">
                    <i class="bi bi-person me-2"></i>
                    <span th:text="${user.name}"></span>
                </div>
            </div>
            <a class="btn btn-outline-primary" th:href="${dashboardUrl}">
                <i class="bi bi-grid me-2"></i>Dashboard
            </a>
        </div>

        <!-- Period Selection -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form th:action="@{/user/register}" method="get" class="d-flex gap-3 align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <label for="yearSelect" class="form-label mb-0">Year:</label>
                        <select id="yearSelect" name="year" class="form-select" style="width: auto;">
                            <option th:each="y : ${#numbers.sequence(2020, 2030)}"
                                    th:value="${y}"
                                    th:text="${y}"
                                    th:selected="${y == currentYear}">
                                2024
                            </option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <a th:each="m : ${#numbers.sequence(1, 12)}"
                           th:href="@{/user/register(year=${currentYear},month=${m})}"
                           th:text="${T(java.time.Month).of(m)}"
                           th:class="${'btn btn-outline-primary' + (m == currentMonth ? ' active' : '')}">
                            Month
                        </a>
                    </div>
                </form>
                <!-- Summary Statistics -->
                <div class="mt-4">
                    <h5 class="mb-3">Monthly Summary</h5>
                    <div class="card">
                        <div class="card-body">
                            <!-- Action Types - Single line -->
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <h6 class="card-subtitle mb-0 me-3">Action Types:</h6>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-order">ORDIN: <span id="count-ordin">0</span></span>
                                    <span class="badge bg-reorder">REORDIN: <span id="count-reordin">0</span></span>
                                    <span class="badge bg-sample">CAMPION: <span id="count-campion">0</span></span>
                                    <span class="badge bg-strikeoff">PROBA STAMPA: <span
                                            id="count-proba-stampa">0</span></span>
                                    <span class="badge bg-designs">DESIGN: <span id="count-design">0</span></span>
                                    <span class="badge bg-other">ALTELE: <span id="count-others">0</span></span>
                                    <span class="badge bg-layout">IMPOSTARE: <span id="count-impostare">0</span></span>
                                </div>
                            </div>

                            <!-- Key Metrics - Single line -->
                            <div class="d-flex align-items-center gap-4">
                                <h6 class="card-subtitle mb-0 me-3">Key Metrics:</h6>
                                <div class="d-flex gap-4">
                                    <span>Total Entries: <strong id="total-entries">0</strong></span>
                                    <span>Total (No Impostare): <strong
                                            id="total-entries-no-impostare">0</strong></span>
                                    <span>Avg Articles (No Impostare): <strong id="avg-articles">0.00</strong></span>
                                    <span>Avg Complexity (No Impostare): <strong id="avg-complexity">0.00</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Form -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form id="registerForm"
                      th:action="@{/user/register/entry}"
                      method="post"
                      class="row g-3 needs-validation"
                      novalidate>

                    <input type="hidden" name="year" th:value="${currentYear}">
                    <input type="hidden" name="month" th:value="${currentMonth}">
                    <input type="hidden" name="entryId" id="editingId">
                    <input type="hidden" name="isEdit" id="isEdit" value="false">

                    <!-- Single Row with adjusted column sizes -->
                    <div class="col-auto" style="width: 130px;">
                        <label for="dateInput" class="form-label">Date*</label>
                        <input id="dateInput" type="date" class="form-control form-control-sm" name="date" required
                               th:value="${param.form_date != null ? param.form_date[0] : #temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}">
                    </div>

                    <div class="col-auto" style="width: 150px;">
                        <label for="orderIdInput" class="form-label">Order ID*</label>
                        <input id="orderIdInput" type="text" class="form-control form-control-sm" name="orderId"
                               required
                               th:value="${param.form_orderId != null ? param.form_orderId[0] : ''}"
                               title="Format: 0000/00/AA or FARA ID"
                               placeholder="1234/24/AB-GREEN">
                    </div>

                    <div class="col-auto" style="width: 140px;">
                        <label for="productionIdInput" class="form-label">Production ID</label>
                        <input id="productionIdInput" type="text" class="form-control form-control-sm"
                               name="productionId"
                               th:value="${param.form_productionId != null ? param.form_productionId[0] : ''}"
                               title="Format: ABCD00-00000"
                               placeholder="CVEX24-123456">
                    </div>

                    <div class="col-auto" style="width: 140px;">
                        <label for="omsIdInput" class="form-label">OMS ID/EMAIL*</label>
                        <input id="omsIdInput" type="text" class="form-control form-control-sm" name="omsId" required
                               th:value="${param.form_omsId != null ? param.form_omsId[0] : ''}"
                               title="Format: OMS00-000000, EMAIL, Sample ID, or OTHER"
                               placeholder="OMS24-1234567">
                    </div>

                    <div class="col" style="min-width: 170px;">
                        <label for="clientNameInput" class="form-label">Client Name*</label>
                        <input id="clientNameInput" type="text" class="form-control form-control-sm" name="clientName"
                               required
                               th:value="${param.form_clientName != null ? param.form_clientName[0] : ''}"
                               placeholder="Ex: ORBEA, CRAFT">
                    </div>

                    <div class="col-auto" style="width: 160px;">
                        <label for="actionTypeSelect" class="form-label">Action Type*</label>
                        <select id="actionTypeSelect" class="form-select form-select-sm" name="actionType" required>
                            <option value="">Select Type</option>
                            <option th:each="type : ${actionTypes}"
                                    th:value="${type}"
                                    th:selected="${param.form_actionType != null && param.form_actionType[0] == type}"
                                    th:text="${type}">Action Type
                            </option>
                        </select>
                    </div>

                    <div class="col-auto" style="width: 140px;">
                        <label for="printPrepTypeSelect" class="form-label">Print Prep Types*</label>
                        <select class="form-select form-select-sm select2-input"
                                multiple
                                name="printPrepTypes"
                                id="printPrepTypeSelect"
                                required>
                            <option th:each="type : ${printPrepTypes}"
                                    th:value="${type}"
                                    th:text="${type}"
                                    th:selected="${param.form_printPrepTypes != null && #strings.containsAny(param.form_printPrepTypes[0], type)}">
                            </option>
                        </select>
                    </div>

                    <div class="col-auto" style="width: 90px;">
                        <label for="colorsInput" class="form-label">Colors*</label>
                        <input id="colorsInput" type="text" class="form-control form-control-sm" name="colorsProfile"
                               required
                               th:value="${param.form_colorsProfile != null ? param.form_colorsProfile[0] : ''}"
                               pattern="[A-Za-z]{0,2}"
                               title="Maximum 2 letters"
                               maxlength="2"
                               placeholder="A">
                    </div>

                    <div class="col-auto" style="width: 90px;">
                        <label for="articlesInput" class="form-label">Articles*</label>
                        <input id="articlesInput" type="number" class="form-control form-control-sm"
                               name="articleNumbers"
                               th:value="${param.form_articleNumbers != null ? param.form_articleNumbers[0] : ''}"
                               min="1" max="99" required>
                    </div>

                    <div class="col-auto" style="width: 90px;">
                        <label for="complexityInput" class="form-label">Complexity</label>
                        <input id="complexityInput" type="number" class="form-control form-control-sm"
                               name="graphicComplexity"
                               th:value="${param.form_graphicComplexity != null ? param.form_graphicComplexity[0] : ''}"
                               min="0" max="10" step="0.5">
                    </div>

                    <div class="col" style="min-width: 120px;">
                        <label for="observationsInput" class="form-label">Observations</label>
                        <input id="observationsInput" type="text" class="form-control form-control-sm"
                               name="observations"
                               th:value="${param.form_observations != null ? param.form_observations[0] : ''}"
                               maxlength="500"
                               placeholder="Observatii">
                    </div>

                    <div class="col-auto" style="width: 360px;">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm"
                                    style="width: 115px; height: 31px; padding: 0.25rem 0.5rem;">
                                <i class="bi bi-plus-circle me-1"></i>Add Entry
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                    onclick="window.registerFormHandler.resetForm()"
                                    style="width: 115px; height: 31px; padding: 0.25rem 0.5rem;">
                                <i class="bi bi-x-circle me-1"></i>Clear
                            </button>
                            <a th:href="@{/user/register/export(year=${currentYear},month=${currentMonth})}"
                               class="btn btn-outline-success btn-sm"
                               style="width: 115px; height: 31px; padding: 0.25rem 0.5rem;">
                                <i class="bi bi-file-excel me-1"></i>Export
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Entries Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="card-title mb-0">Register Entries</h5>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Order ID</th>
                            <th>Production ID</th>
                            <th>OMS ID</th>
                            <th>Client</th>
                            <th>Action</th>
                            <th>Print Type</th>
                            <th>Colors</th>
                            <th>Articles</th>
                            <th>Complexity</th>
                            <th>Observations</th>
                            <th>Admin Sync</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="entry : ${entries}">
                            <td th:text="${entry.entryId}"></td>
                            <td th:text="${#temporals.format(entry.date, 'dd/MM/yyyy')}"></td>
                            <td th:text="${entry.orderId}"></td>
                            <td th:text="${entry.productionId}"></td>
                            <td th:text="${entry.omsId}"></td>
                            <td th:text="${entry.clientName}"></td>
                            <td th:text="${entry.actionType}"></td>
                            <td th:text="${#strings.listJoin(entry.printPrepTypes, ', ')}">DIGITAL, SBS</td>
                            <td th:text="${entry.colorsProfile}"></td>
                            <td th:text="${entry.articleNumbers}"></td>
                            <td th:text="${entry.graphicComplexity}"></td>
                            <td th:text="${entry.observations}"></td>
                            <td>
                                <span th:switch="${entry.adminSync}">
                                    <span th:case="'ADMIN_EDITED'"
                                          class="badge bg-info">Edited</span>
                                    <span th:case="'USER_INPUT'"
                                          class="badge bg-secondary">In Process</span>
                                    <span th:case="'USER_DONE'"
                                          class="badge bg-success">Synced</span>
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <!-- Edit button -->
                                    <a href="#"
                                       class="btn btn-sm btn-outline-primary edit-entry"
                                       th:data-entry-id="${entry.entryId}"
                                       th:data-date="${#temporals.format(entry.date, 'yyyy-MM-dd')}"
                                       th:data-order-id="${entry.orderId}"
                                       th:data-production-id="${entry.productionId}"
                                       th:data-oms-id="${entry.omsId}"
                                       th:data-client-name="${entry.clientName}"
                                       th:data-action-type="${entry.actionType}"
                                       th:data-print-prep-types="${#strings.listJoin(entry.printPrepTypes, ', ')}"
                                       th:data-colors-profile="${entry.colorsProfile}"
                                       th:data-article-numbers="${entry.articleNumbers}"
                                       th:data-graphic-complexity="${entry.graphicComplexity}"
                                       th:data-observations="${entry.observations}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <!-- Delete button  -->
                                    <form th:action="@{/user/register/delete}"
                                          method="post"
                                          style="display: inline;">
                                        <input type="hidden" name="entryId" th:value="${entry.entryId}"/>
                                        <input type="hidden" name="year" th:value="${currentYear}"/>
                                        <input type="hidden" name="month" th:value="${currentMonth}"/>
                                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Are you sure you want to delete this entry?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${entries.empty}">
                            <td colspan="14" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="bi bi-journal-x fs-2"></i>
                                    <h5 class="mt-3">No Entries Found</h5>
                                    <p>No register entries were found for this period.</p>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <th:block layout:fragment="scripts">
            <script th:inline="javascript">
                // Constants for complexity calculations
                const ACTION_TYPE_VALUES = {
                    'ORDIN': 2.5,
                    'REORDIN': 1.0,
                    'CAMPION': 2.5,
                    'PROBA STAMPA': 2.5,
                    'ORD SPIZED': 2.0,
                    'PROBA CULOARE': 2.5,
                    'CARTELA CULORI': 2.5,
                    'DESIGN': 2.5,
                    'DESIGN 3D': 2.5,
                    'PATTERN PREP': 2.5,
                    'IMPOSTARE': 0.0,
                    'OTHER': 2.5
                };

                // Print prep types that add complexity
                const COMPLEXITY_PRINT_PREPS = {
                    'SBS': 0.5,
                    'NN': 0.5,
                    'NAME': 0.5,
                    'NUMBER': 0.5,
                    'FLEX': 0.5,
                    'BRODERIE': 0.5,
                    'OTHER': 0.5
                };

                // Print prep types that don't affect complexity
                const NEUTRAL_PRINT_PREPS = {
                    'DIGITAL': 0.0,
                    'GPT': 0.0,
                    'FILM': 0.0
                };

                class RegisterFormHandler {
                    constructor() {
                        this.form = document.getElementById('registerForm');
                        this.initializeFormElements();
                        this.initializeForm();
                    }

                    initializeFormElements() {
                        this.actionTypeSelect = document.getElementById('actionTypeSelect');
                        this.printPrepSelect = document.getElementById('printPrepTypeSelect');
                        this.complexityInput = document.getElementById('complexityInput');
                        this.colorsInput = document.getElementById('colorsInput');
                        this.defaultUrl = '/user/register/entry';
                    }

                    initializeForm() {
                        if (!this.form) return;

                        // Initialize Select2 with simplified configuration
                        $(this.printPrepSelect).select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            placeholder: 'Select types',
                            multiple: true,
                            dropdownParent: $(this.printPrepSelect).parent(),
                            selectionCssClass: 'form-select-sm'
                        });

                        this.setupEventListeners();
                        this.initializeDefaultValues();
                    }

                    initializeSelect2() {
                        // Initialize Select2 with custom configuration
                        this.printPrepSelect.select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            placeholder: 'Select print types...',
                            allowClear: true,
                            multiple: true,
                            closeOnSelect: false,
                            dropdownCssClass: 'select2-dropdown-medium'
                        });
                    }

                    prepareFormData() {
                        // Ensure printPrepTypes are properly set in the form
                        const selectedPrintTypes = $(this.printPrepSelect).val();
                        if (selectedPrintTypes) {
                            // Create hidden inputs for each selected print type
                            selectedPrintTypes.forEach(type => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = 'printPrepTypes[]';
                                input.value = type;
                                this.form.appendChild(input);
                            });
                        }
                    }

                    setupEventListeners() {
                        // Form submission
                        this.form.addEventListener('submit', (e) => this.handleSubmit(e));

                        // Action type changes
                        this.actionTypeSelect.addEventListener('change', () => {
                            this.autoFillColors();
                            this.updateComplexityField();
                        });

                        // Print prep type changes
                        $(this.printPrepSelect).on('change', () => {
                            this.updateComplexityField();
                        });

                        // Edit button handlers
                        document.querySelectorAll('.edit-entry').forEach(button => {
                            button.addEventListener('click', (e) => {
                                e.preventDefault();
                                this.populateForm(button);
                            });
                        });

                        // Clear button
                        const clearButton = this.form.querySelector('button[type="button"]');
                        if (clearButton) {
                            clearButton.addEventListener('click', () => this.resetForm());
                        }
                    }

                    initializeDefaultValues() {
                        // Set default date to today
                        const dateInput = this.form.querySelector('input[name="date"]');
                        if (dateInput) {
                            dateInput.value = new Date().toISOString().split('T')[0];
                        }

                        this.autoFillColors();
                        this.updateComplexityField();
                    }

                    calculateComplexity(actionType, printPrepTypes) {
                        if (!actionType) return 0;

                        // Special cases first
                        if (actionType === 'IMPOSTARE') return 0.0;
                        if (actionType === 'REORDIN') return 1.0;
                        if (actionType === 'ORD SPIZED') return 2.0;

                        // Fixed value actions
                        const fixedValueActions = [
                            'PROBA CULOARE', 'PROBA STAMPA', 'CARTELA CULORI',
                            'DESIGN', 'DESIGN 3D', 'PATTERN PREP', 'OTHER'
                        ];

                        if (fixedValueActions.includes(actionType)) {
                            return ACTION_TYPE_VALUES[actionType];
                        }

                        // For ORDIN and CAMPION, check print prep types
                        if (actionType === 'ORDIN' || actionType === 'CAMPION') {
                            const baseValue = ACTION_TYPE_VALUES[actionType];

                            // If no print prep types selected, return base value
                            if (!printPrepTypes || !printPrepTypes.length) return baseValue;

                            // Check if any complexity-adding print prep types are selected
                            const hasComplexityType = printPrepTypes.some(type => type in COMPLEXITY_PRINT_PREPS);

                            // If any complexity-adding type is selected, return maximum complexity (3.0)
                            if (hasComplexityType) {
                                return 3.0;
                            }

                            // If only neutral types are selected, return base value
                            return baseValue;
                        }

                        return ACTION_TYPE_VALUES[actionType] || 0;
                    }

                    updateComplexityField() {
                        if (!this.complexityInput || !this.actionTypeSelect) return;

                        // Get selected values correctly
                        const selectedTypes = Array.from($(this.printPrepSelect).select2('data'))
                            .map(item => item.text);

                        const complexity = this.calculateComplexity(this.actionTypeSelect.value, selectedTypes);

                        if (complexity >= 0) {
                            this.complexityInput.value = complexity.toFixed(1);
                        }
                    }

                    autoFillColors() {
                        if (!this.colorsInput) return;

                        // Auto-fill with 'A' if empty and action type is selected
                        if (this.actionTypeSelect.value && (!this.colorsInput.value || this.colorsInput.value.trim() === '')) {
                            this.colorsInput.value = 'A';
                        }
                    }

                    validateForm() {
                        const requiredFields = [
                            { name: 'date', message: 'missing_date' },
                            { name: 'orderId', message: 'missing_order_id' },
                            { name: 'omsId', message: 'missing_oms_id' },
                            { name: 'clientName', message: 'missing_client' },
                            { name: 'actionType', message: 'missing_action_type' },
                            { name: 'articleNumbers', message: 'missing_articles' }
                        ];

                        // Check regular fields
                        for (const field of requiredFields) {
                            const element = this.form.elements[field.name];
                            if (!element || !element.value || element.value.trim() === '') {
                                this.handleValidationError(field.message);
                                return false;
                            }
                        }

                        // Special check for printPrepTypes (Select2 multiple)
                        const selectedPrintTypes = $(this.printPrepSelect).val();
                        if (!selectedPrintTypes || selectedPrintTypes.length === 0) {
                            this.handleValidationError('missing_print_type');
                            return false;
                        }

                        return true;
                    }

                    handleValidationError(errorMessage) {
                        const formData = new FormData(this.form);
                        const params = new URLSearchParams();

                        params.append('error', errorMessage);
                        formData.forEach((value, key) => {
                            if (value && value.trim() !== '') {
                                params.append('form_' + key, value);
                            }
                        });

                        // Preserve year and month
                        params.append('year', formData.get('year'));
                        params.append('month', formData.get('month'));

                        window.location.href = '/user/register?' + params.toString();
                    }

                    handleSubmit(event) {
                        event.preventDefault();

                        if (!this.validateForm()) {
                            return;
                        }

                        // Clear any existing printPrepTypes hidden fields
                        this.form.querySelectorAll('input[name="printPrepTypes"]').forEach(el => el.remove());

                        // Get selected print types from Select2 and remove duplicates
                        const selectedPrintTypes = Array.from(new Set($(this.printPrepSelect).val()));

                        if (selectedPrintTypes && selectedPrintTypes.length > 0) {
                            // Create a hidden input for each unique selected print type
                            selectedPrintTypes.forEach(type => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = 'printPrepTypes';
                                input.value = type;
                                this.form.appendChild(input);
                            });
                        }

                        // Submit the form
                        this.form.submit();
                    }

                    scrollToForm() {
                        this.form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }

                    resetForm() {
                        this.form.reset();
                        this.form.action = this.defaultUrl;
                        this.form.method = 'post';

                        // Reset hidden fields
                        document.getElementById('editingId').value = '';
                        document.getElementById('isEdit').value = 'false';

                        // Reset date to today
                        const dateInput = this.form.querySelector('input[name="date"]');
                        if (dateInput) {
                            dateInput.value = new Date().toISOString().split('T')[0];
                        }

                        // Reset Select2
                        $(this.printPrepSelect).val(null).trigger('change');

                        // Reset submit button
                        const submitButton = this.form.querySelector('button[type="submit"]');
                        submitButton.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Add Entry';

                        // Update calculated fields
                        this.autoFillColors();
                        this.updateComplexityField();
                    }

                    populateForm(button) {
                        const entryId = button.getAttribute('data-entry-id');
                        this.form.action = `${this.defaultUrl}/${entryId}`;
                        this.form.method = 'post';

                        // Handle print prep types correctly - remove duplicates when populating
                        const printPrepTypesStr = button.getAttribute('data-print-prep-types');
                        if (printPrepTypesStr) {
                            const printPrepTypes = [...new Set(
                                printPrepTypesStr.split(', ')
                                    .map(type => type.trim())
                                    .filter(type => type)
                            )];
                            $(this.printPrepSelect).val(printPrepTypes).trigger('change');
                        }

                        // Populate all fields
                        const fields = [
                            'date', 'orderId', 'productionId', 'omsId', 'clientName',
                            'actionType', 'colorsProfile', 'articleNumbers',
                            'graphicComplexity', 'observations'
                        ];

                        fields.forEach(field => {
                            const input = this.form.querySelector(`[name="${field}"]`);
                            if (input) {
                                input.value = button.getAttribute(`data-${field.replace(/([A-Z])/g, '-$1').toLowerCase()}`) || '';
                            }
                        });

                        // Update button text
                        const submitButton = this.form.querySelector('button[type="submit"]');
                        submitButton.innerHTML = '<i class="bi bi-check-circle me-1"></i>Update';

                        this.scrollToForm();
                    }
                }

                class RegisterSummaryHandler {
                    constructor() {
                        // Initialize counters
                        this.actionCounts = {
                            ordin: 0,
                            reordin: 0,
                            campion: 0,
                            probaStampa: 0,
                            design: 0,
                            others: 0,
                            impostare: 0
                        };

                        this.metrics = {
                            totalEntries: 0,
                            totalNoImpostare: 0,
                            avgArticles: 0,
                            avgComplexity: 0
                        };

                        this.setupObserver();
                        // Initial calculation
                        try {
                            this.calculateStats();
                        } catch (error) {
                            console.error('Error calculating initial stats:', error);
                        }

                        // Add form submission handler to recalculate after form actions
                        const registerForm = document.getElementById('registerForm');
                        if (registerForm) {
                            registerForm.addEventListener('submit', () => {
                                // Allow time for DOM to update
                                setTimeout(() => this.calculateStats(), 100);
                            });
                        }
                    }

                    setupObserver() {
                        try {
                            const tableBody = document.querySelector('.table tbody');
                            if (tableBody) {
                                const observer = new MutationObserver((mutations) => {
                                    // Check if mutations actually affect our data
                                    const hasRelevantChanges = mutations.some(mutation =>
                                    mutation.type === 'childList' ||
                                    (mutation.type === 'characterData' &&
                                    mutation.target.parentElement?.tagName === 'TD')
                                    );

                                    if (hasRelevantChanges) {
                                        this.calculateStats();
                                    }
                                });

                                observer.observe(tableBody, {
                                    childList: true,
                                    subtree: true,
                                    characterData: true
                                });
                            }
                        } catch (error) {
                            console.error('Error setting up observer:', error);
                        }
                    }

                    calculateStats() {

                        try {
                            // Reset counters
                            Object.keys(this.actionCounts).forEach(key => this.actionCounts[key] = 0);
                            // Get all valid entries (excluding empty state row)
                            const entries = Array.from(document.querySelectorAll('.table tbody tr'))
                                .filter(row => !row.querySelector('.text-muted') && row.cells.length > 10);


                            let totalArticles = 0;
                            let totalComplexity = 0;
                            let nonImpostareCount = 0;

                            // Process each entry
                            entries.forEach(row => {
                                const cells = row.cells;
                                const actionType = cells[6]?.textContent?.trim().toUpperCase();
                                const articles = parseInt(cells[9]?.textContent || '0');
                                const complexity = parseFloat(cells[10]?.textContent || '0');

                                // Count action types
                                switch(actionType) {
                                    case 'ORDIN': this.actionCounts.ordin++; break;
                                    case 'REORDIN': this.actionCounts.reordin++; break;
                                    case 'CAMPION': this.actionCounts.campion++; break;
                                    case 'PROBA STAMPA': this.actionCounts.probaStampa++; break;
                                    case 'DESIGN':
                                    case 'DESIGN 3D':this.actionCounts.design++;break;
                                    case 'IMPOSTARE': this.actionCounts.impostare++; break;
                                    default: this.actionCounts.others++; break;
                                }

                                // Calculate metrics excluding IMPOSTARE entries
                                if (actionType !== 'IMPOSTARE') {
                                    nonImpostareCount++;
                                    totalArticles += articles;
                                    totalComplexity += complexity;
                                }
                            });

                            // Calculate metrics
                            this.metrics.totalEntries = entries.length;
                            this.metrics.totalNoImpostare = nonImpostareCount;
                            this.metrics.avgArticles = nonImpostareCount ?
                            (totalArticles / nonImpostareCount).toFixed(2) : '0.00';
                            this.metrics.avgComplexity = nonImpostareCount ?
                            (totalComplexity / nonImpostareCount).toFixed(2) : '0.00';

                            this.updateUI();

                        } catch (error) {
                            console.error('Error calculating stats:', error);
                            // Reset to safe values on error
                            this.resetStats();
                        }
                    }

                    resetStats() {
                        Object.keys(this.actionCounts).forEach(key => this.actionCounts[key] = 0);
                        this.metrics = {
                            totalEntries: 0,
                            totalNoImpostare: 0,
                            avgArticles: '0.00',
                            avgComplexity: '0.00'
                        };
                        this.updateUI();
                    }

                    updateUI() {
                        try {
                            const elements = {
                                'count-ordin': this.actionCounts.ordin,
                                'count-reordin': this.actionCounts.reordin,
                                'count-campion': this.actionCounts.campion,
                                'count-proba-stampa': this.actionCounts.probaStampa,
                                'count-design': this.actionCounts.design,
                                'count-others': this.actionCounts.others,
                                'count-impostare': this.actionCounts.impostare,
                                'total-entries': this.metrics.totalEntries,
                                'total-entries-no-impostare': this.metrics.totalNoImpostare,
                                'avg-articles': this.metrics.avgArticles,
                                'avg-complexity': this.metrics.avgComplexity
                            };

                            Object.entries(elements).forEach(([id, value]) => {
                                const element = document.getElementById(id);
                                if (element) {
                                    element.textContent = value;
                                }
                            });
                        } catch (error) {
                            console.error('Error updating UI:', error);
                        }
                    }
                }

                // Initialize on DOM load
                document.addEventListener('DOMContentLoaded', () => {
                    window.registerFormHandler = new RegisterFormHandler();
                    window.registerSummaryHandler = new RegisterSummaryHandler();
                });
            </script>
        </th:block>
    </div>
</div>
</body>
</html>