<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}" lang="en">
<head>
    <title>User Utilities</title>
    <link rel="stylesheet" th:href="@{/css/utility.css?v=101120251023}">
</head>

<body>
<div layout:fragment="content">
    <div class="container py-4">
        <!-- Header Section -->
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="header-title">
                    <i class="bi bi-tools me-2"></i>User Utilities
                </h1>
                <p class="header-subtitle mb-0">
                    Complete self-service tools for backup management, diagnostics, and troubleshooting
                </p>
            </div>
            <a class="btn btn-outline-primary" th:href="${dashboardUrl != null ? dashboardUrl : '/dashboard'}">
                <i class="bi bi-grid me-2"></i>Dashboard
            </a>
        </div>

        <div class="mb-4">
            <div class="header-stats">
                <div class="stat-card">
                    <i class="bi bi-person-check"></i>
                    <div class="stat-info">
                        <span class="stat-label">Current User</span>
                        <span class="stat-value" th:text="${user.username}">Username</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="bi bi-clock"></i>
                    <div class="stat-info">
                        <span class="stat-label">Current Time</span>
                        <span class="stat-value" id="utility-live-clock">--:--:--</span>
                    </div>
                </div>
                <div class="stat-card" id="system-health-indicator">
                    <i class="bi bi-heart-pulse"></i>
                    <div class="stat-info">
                        <span class="stat-label">System Health</span>
                        <span class="stat-value" id="health-status">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Bar -->
        <div class="quick-actions-bar mb-4">
            <button id="emergency-reset-top-btn" class="btn-emergency" title="Emergency Cache Reset">
                <i class="bi bi-exclamation-triangle"></i>
                <span>Emergency Reset</span>
            </button>
            <button id="session-reset-top-btn" class="btn-warning" title="Manual Session Reset">
                <i class="bi bi-arrow-clockwise"></i>
                <span>Session Reset</span>
            </button>
            <button id="refresh-all-top-btn" class="btn-primary" title="Refresh All Data">
                <i class="bi bi-arrow-repeat"></i>
                <span>Refresh All</span>
            </button>
            <button id="system-summary-top-btn" class="btn-info" title="System Summary">
                <i class="bi bi-clipboard-data"></i>
                <span>System Summary</span>
            </button>
        </div>

        <!-- Utilities Grid -->
        <div class="utilities-grid">

            <!-- Backup Management - Enhanced -->
            <div th:replace="~{utility/backup-fragment :: backup-utility}"></div>

            <!-- Cache & System Monitoring - Enhanced -->
            <div th:replace="~{utility/monitor-fragment :: monitor-utility}"></div>

            <!-- Session Diagnostics - Now Functional -->
            <div th:replace="~{utility/session-fragment :: session-utility}"></div>

            <!-- Merge Management - New -->
            <div th:replace="~{utility/merge-fragment :: merge-utility}"></div>

            <!-- System Health - Now Functional -->
            <div th:replace="~{utility/health-fragment :: health-utility}"></div>

            <!-- File System & Diagnostics - Now Functional -->
            <div th:replace="~{utility/diagnostics-fragment :: diagnostics-utility}"></div>

            <!-- Quick Actions - Now Functional -->
            <div th:replace="~{utility/actions-fragment :: actions-utility}"></div>

        </div>

        <!-- System Status Summary -->
        <div class="system-status-summary mt-4" id="system-status-summary" style="display: none;">
            <div class="status-header">
                <h4>System Status Summary</h4>
                <button id="close-summary" class="btn-close">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="status-content" id="system-summary-content">
                <!-- System summary will be loaded here -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="utility-navigation mt-4">
            <a th:href="@{/}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Home
            </a>
            <div class="navigation-info">
                <span class="info-text">
                    <i class="bi bi-info-circle"></i>
                    All utilities are designed for self-service troubleshooting and recovery
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Modern ES6 Utility Modules - Fully Migrated -->
<th:block layout:fragment="scripts">
    <!-- ES6 Utilities (Modern Browsers) - Full ES6 Implementation -->
    <!-- All utilities and coordinator migrated from jQuery to ES6 modules -->
    <script type="module">
        const cacheBuster = new Date().getTime();

        // Import ES6 Utility Modules
        import(`/js/features/utilities/common/BackupUtility.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Backup utility loaded (ES6)'))
            .catch(err => console.error('‚ùå Error loading backup utility:', err));

        import(`/js/features/utilities/common/MonitorUtility.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Monitor utility loaded (ES6)'))
            .catch(err => console.error('‚ùå Error loading monitor utility:', err));

        import(`/js/features/utilities/common/HealthUtility.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Health utility loaded (ES6)'))
            .catch(err => console.error('‚ùå Error loading health utility:', err));

        import(`/js/features/utilities/common/DiagnosticsUtility.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Diagnostics utility loaded (ES6)'))
            .catch(err => console.error('‚ùå Error loading diagnostics utility:', err));

        import(`/js/features/utilities/common/ActionsUtility.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Actions utility loaded (ES6)'))
            .catch(err => console.error('‚ùå Error loading actions utility:', err));

        import(`/js/features/utilities/common/MergeUtility.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Merge utility loaded (ES6)'))
            .catch(err => console.error('‚ùå Error loading merge utility:', err));

        import(`/js/features/utilities/common/SessionUtility.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Session utility loaded (ES6)'))
            .catch(err => console.error('‚ùå Error loading session utility:', err));

        // Import coordinator
        import(`/js/features/utilities/common/index.js?v=101120251023${cacheBuster}`)
            .then(() => console.log('‚úÖ Utilities - ES6 coordinator loaded (hybrid mode)'))
            .catch(err => console.error('‚ùå Error loading utilities coordinator:', err));
    </script>

    <!-- Legacy modules - NO LONGER NEEDED -->
    <!-- MIGRATED TO ES6: ALL utilities (backup, monitor, health, diagnostics, actions, merge, session) -->
    <!-- All functionality now provided by ES6 UtilityCoordinator (loaded via index.js above) -->
    <!-- <script th:src="@{/js/legacy/um/merge-utility.js?v=101120251023}"></script> -->
    <!-- <script th:src="@{/js/legacy/um/diagnostics-utility.js?v=101120251023}"></script> -->
    <!-- <script th:src="@{/js/legacy/um/actions-utility.js?v=101120251023}"></script> -->
    <!-- <script th:src="@{/js/legacy/utility-core.js?v=101120251023}"></script> -->

    <!-- Initialization script -->
    <script th:inline="javascript">
        $(document).ready(function() {
            console.log('üîß User Utilities fully loaded - Self-service mode active');
            console.log('üì¶ Loaded utilities:', {
                backup: typeof window.BackupUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                monitor: typeof window.MonitorUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                merge: typeof window.MergeUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                health: typeof window.HealthUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                diagnostics: typeof window.DiagnosticsUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                actions: typeof window.ActionsUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                main: typeof window.UtilityMain !== 'undefined' ? '‚úÖ' : '‚ùå'
            });

            // Initialize system health check
            if (typeof window.initializeSystemHealth === 'function') {
                window.initializeSystemHealth();
            }

            // Setup quick actions
            setupQuickActions();

            // Initialize auto-refresh for all utilities
            initializeAutoRefresh();
            initializeLiveClock();

            // Show welcome message
            setTimeout(function() {
                if (typeof window.showToast === 'function') {
                    window.showToast('Welcome', 'All utility services are ready for self-service operations', 'info');
                }
            }, 1500);
        });

        // Live Clock Update - Format: dd/MM/YYYY - HH:mm
        function initializeLiveClock() {
            const updateClock = function() {
                const clockElement = document.getElementById('utility-live-clock');
                if (clockElement) {
                    const now = new Date();

                    // Format as dd/MM/YYYY - HH:mm
                    const day = String(now.getDate()).padStart(2, '0');
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const year = now.getFullYear();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');

                    const formattedTime = `${day}/${month}/${year} - ${hours}:${minutes}`;
                    clockElement.textContent = formattedTime;
                }
            };

            // Update every second
            setInterval(updateClock, 1000);
            updateClock(); // Initial call
        }

        // Quick Actions Setup
        // NOTE: Top-level quick action buttons (with -top-btn suffix) call coordinator functions
        // Fragment buttons are handled by their respective ES6 modules
        function setupQuickActions() {
            console.log('üöÄ Setting up quick actions...');

            // Emergency Reset (top bar button - calls coordinator function)
            $('#emergency-reset-top-btn').click(function() {
                if (typeof window.performEmergencyReset === 'function') {
                    window.performEmergencyReset();
                } else {
                    console.warn('performEmergencyReset function not available');
                }
            });

            // Manual Session Reset (top bar button - calls coordinator function)
            $('#session-reset-top-btn').click(function() {
                if (typeof window.performSessionReset === 'function') {
                    window.performSessionReset();
                } else {
                    console.warn('performSessionReset function not available');
                }
            });

            // Refresh All (top bar button - calls coordinator function)
            $('#refresh-all-top-btn').click(function() {
                if (typeof window.refreshAllUtilities === 'function') {
                    window.refreshAllUtilities();
                } else {
                    console.warn('refreshAllUtilities function not available');
                }
            });

            // System Summary (top bar button - calls coordinator function)
            $('#system-summary-top-btn').click(function() {
                if (typeof window.showSystemSummary === 'function') {
                    window.showSystemSummary();
                } else {
                    console.warn('showSystemSummary function not available');
                }
            });

            // Close Summary (generic UI action)
            $('#close-summary').click(function() {
                $('#system-status-summary').fadeOut();
            });

            console.log('‚úÖ Quick actions setup complete (calls coordinator functions)');
        }

        // Auto-refresh setup for all utilities
        function initializeAutoRefresh() {
            console.log('‚è∞ Initializing auto-refresh for all utilities...');

            // Refresh system status every 5 minutes
            setInterval(function() {
                if (typeof window.refreshSystemStatus === 'function') {
                    window.refreshSystemStatus();
                }
            }, 300000); // 5 minutes

            // Refresh individual utility overviews
            setInterval(function() {
                // Health overview
                if (typeof window.HealthUtility !== 'undefined' && window.HealthUtility.refreshOverview) {
                    window.HealthUtility.refreshOverview();
                }

                // Monitor overview
                if (typeof window.MonitorUtility !== 'undefined' && window.MonitorUtility.refreshOverview) {
                    window.MonitorUtility.refreshOverview();
                }

                // Session overview
                if (typeof window.SessionUtility !== 'undefined' && window.SessionUtility.refreshStatus) {
                    window.SessionUtility.refreshStatus();
                }
            }, 180000); // 3 minutes

            console.log('‚úÖ Auto-refresh initialized for all utilities');
        }

        // Global error handler for utility operations
        window.addEventListener('error', function(event) {
            console.error('Utility Error:', event.error);
            if (typeof window.showToast === 'function') {
                window.showToast('System Error', 'An unexpected error occurred. Check console for details.', 'error');
            }
        });

        // Global utility status checker
        window.checkUtilityStatus = function() {
            const utilities = {
                'Backup Management': typeof window.BackupUtility !== 'undefined',
                'Cache Monitoring': typeof window.MonitorUtility !== 'undefined',
                'Session Diagnostics': typeof window.SessionUtility !== 'undefined',
                'Merge Management': typeof window.MergeUtility !== 'undefined',
                'System Health': typeof window.HealthUtility !== 'undefined',
                'Diagnostics': typeof window.DiagnosticsUtility !== 'undefined',
                'Quick Actions': typeof window.ActionsUtility !== 'undefined',
                'Main Coordinator': typeof window.UtilityMain !== 'undefined'
            };

            const allLoaded = Object.values(utilities).every(Boolean);
            const loadedCount = Object.values(utilities).filter(Boolean).length;
            const totalCount = Object.keys(utilities).length;

            console.log(`üìä Utility Status: ${loadedCount}/${totalCount} loaded`);
            console.table(utilities);

            if (typeof window.showToast === 'function') {
                const message = allLoaded ?
                'All utilities are loaded and ready' :
                `${loadedCount}/${totalCount} utilities loaded`;
                const type = allLoaded ? 'success' : 'warning';
                window.showToast('Utility Status', message, type);
            }

            return utilities;
        };

        console.log('‚úÖ Utility initialization complete');
    </script>
</th:block>