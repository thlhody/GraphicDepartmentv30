<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}" lang="en">
<head>
    <title>User Utilities</title>
    <link rel="stylesheet" th:href="@{/css/utility.css?v=291020251458}">
    <link rel="stylesheet" th:href="@{/css/toast-alerts.css?v=291020251458}">
</head>

<body>
<div layout:fragment="content">
    <div class="container py-4">
        <!-- Header Section -->
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="header-title">
                    <i class="bi bi-tools me-2"></i>User Utilities
                </h1>
                <p class="header-subtitle mb-0">
                    Complete self-service tools for backup management, diagnostics, and troubleshooting
                </p>
            </div>
            <a class="btn btn-outline-primary" th:href="${dashboardUrl != null ? dashboardUrl : '/dashboard'}">
                <i class="bi bi-grid me-2"></i>Dashboard
            </a>
        </div>

        <div class="mb-4">
            <div class="header-stats">
                <div class="stat-card">
                    <i class="bi bi-person-check"></i>
                    <div class="stat-info">
                        <span class="stat-label">Current User</span>
                        <span class="stat-value" th:text="${user.username}">Username</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="bi bi-clock"></i>
                    <div class="stat-info">
                        <span class="stat-label">Last Updated</span>
                        <span class="stat-value" th:text="${#temporals.format(currentTime, 'HH:mm:ss')}">--:--:--</span>
                    </div>
                </div>
                <div class="stat-card" id="system-health-indicator">
                    <i class="bi bi-heart-pulse"></i>
                    <div class="stat-info">
                        <span class="stat-label">System Health</span>
                        <span class="stat-value" id="health-status">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Alerts System -->
        <div th:replace="~{alerts/toast-alerts :: toast-alerts}"></div>

        <!-- Quick Actions Bar -->
        <div class="quick-actions-bar mb-4">
            <button id="emergency-reset-btn" class="btn-emergency" title="Emergency Cache Reset">
                <i class="bi bi-exclamation-triangle"></i>
                <span>Emergency Reset</span>
            </button>
            <button id="manual-session-reset-btn" class="btn-warning" title="Manual Session Reset">
                <i class="bi bi-arrow-clockwise"></i>
                <span>Session Reset</span>
            </button>
            <button id="refresh-all-btn" class="btn-primary" title="Refresh All Data">
                <i class="bi bi-arrow-repeat"></i>
                <span>Refresh All</span>
            </button>
            <button id="system-summary-btn" class="btn-info" title="System Summary">
                <i class="bi bi-clipboard-data"></i>
                <span>System Summary</span>
            </button>
        </div>

        <!-- Utilities Grid -->
        <div class="utilities-grid">

            <!-- Backup Management - Enhanced -->
            <div th:replace="~{utility/backup-fragment :: backup-utility}"></div>

            <!-- Cache & System Monitoring - Enhanced -->
            <div th:replace="~{utility/monitor-fragment :: monitor-utility}"></div>

            <!-- Session Diagnostics - Now Functional -->
            <div th:replace="~{utility/session-fragment :: session-utility}"></div>

            <!-- Merge Management - New -->
            <div th:replace="~{utility/merge-fragment :: merge-utility}"></div>

            <!-- System Health - Now Functional -->
            <div th:replace="~{utility/health-fragment :: health-utility}"></div>

            <!-- File System & Diagnostics - Now Functional -->
            <div th:replace="~{utility/diagnostics-fragment :: diagnostics-utility}"></div>

            <!-- Quick Actions - Now Functional -->
            <div th:replace="~{utility/actions-fragment :: actions-utility}"></div>

        </div>

        <!-- System Status Summary -->
        <div class="system-status-summary mt-4" id="system-status-summary" style="display: none;">
            <div class="status-header">
                <h4>System Status Summary</h4>
                <button id="close-summary" class="btn-close">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="status-content" id="system-summary-content">
                <!-- System summary will be loaded here -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="utility-navigation mt-4">
            <a th:href="@{/}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Home
            </a>
            <div class="navigation-info">
                <span class="info-text">
                    <i class="bi bi-info-circle"></i>
                    All utilities are designed for self-service troubleshooting and recovery
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Utility JavaScript with Full Functionality -->
<th:block layout:fragment="scripts">
    <!-- Core utility scripts -->
    <script th:src="@{/js/toast-alerts.js?v=291020251458}"></script>

    <!-- Individual utility modules -->
    <script th:src="@{/js/um/backup-utility.js?v=291020251458}"></script>
    <script th:src="@{/js/um/monitor-utility.js?v=291020251458}"></script>
    <script th:src="@{/js/um/session-utility.js?v=291020251458}"></script>
    <script th:src="@{/js/um/merge-utility.js?v=291020251458}"></script>
    <script th:src="@{/js/um/health-utility.js?v=291020251458}"></script>
    <script th:src="@{/js/um/diagnostics-utility.js?v=291020251458}"></script>
    <script th:src="@{/js/um/actions-utility.js?v=291020251458}"></script>

    <!-- Main utility coordinator -->
    <script th:src="@{/js/utility-core.js?v=291020251458}"></script>

    <!-- Initialization script -->
    <script th:inline="javascript">
        $(document).ready(function() {
            console.log('üîß User Utilities fully loaded - Self-service mode active');
            console.log('üì¶ Loaded utilities:', {
                backup: typeof window.BackupUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                monitor: typeof window.MonitorUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                session: typeof window.SessionUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                merge: typeof window.MergeUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                health: typeof window.HealthUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                diagnostics: typeof window.DiagnosticsUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                actions: typeof window.ActionsUtility !== 'undefined' ? '‚úÖ' : '‚ùå',
                main: typeof window.UtilityMain !== 'undefined' ? '‚úÖ' : '‚ùå'
            });

            // Initialize system health check
            if (typeof window.initializeSystemHealth === 'function') {
                window.initializeSystemHealth();
            }

            // Setup quick actions
            setupQuickActions();

            // Initialize auto-refresh for all utilities
            initializeAutoRefresh();

            // Show welcome message
            setTimeout(function() {
                if (typeof window.showToast === 'function') {
                    window.showToast('Welcome', 'All utility services are ready for self-service operations', 'info');
                }
            }, 1500);
        });

        // Quick Actions Setup
        function setupQuickActions() {
            console.log('üöÄ Setting up quick actions...');

            // Emergency Reset
            $('#emergency-reset-btn').click(function() {
                if (confirm('‚ö†Ô∏è EMERGENCY RESET ‚ö†Ô∏è\n\nThis will completely reset all cached data and session state.\nThis action should only be used if you are experiencing severe issues.\n\nAre you absolutely sure you want to continue?')) {
                    if (typeof window.performEmergencyReset === 'function') {
                        window.performEmergencyReset();
                    } else if (typeof window.ActionsUtility !== 'undefined') {
                        window.ActionsUtility.emergencyReset();
                    }
                }
            });

            // Manual Session Reset
            $('#manual-session-reset-btn').click(function() {
                if (confirm('Reset your current session?\n\nThis will:\n‚Ä¢ Clear session data\n‚Ä¢ Reset monitoring state\n‚Ä¢ Refresh user context\n\nContinue?')) {
                    if (typeof window.performSessionReset === 'function') {
                        window.performSessionReset();
                    } else if (typeof window.SessionUtility !== 'undefined') {
                        window.SessionUtility.performReset();
                    }
                }
            });

            // Refresh All
            $('#refresh-all-btn').click(function() {
                if (typeof window.refreshAllUtilities === 'function') {
                    window.refreshAllUtilities();
                } else if (typeof window.ActionsUtility !== 'undefined') {
                    window.ActionsUtility.refreshAll();
                }
            });

            // System Summary
            $('#system-summary-btn').click(function() {
                if (typeof window.showSystemSummary === 'function') {
                    window.showSystemSummary();
                } else if (typeof window.DiagnosticsUtility !== 'undefined') {
                    window.DiagnosticsUtility.getSystemSummary();
                }
            });

            // Close Summary
            $('#close-summary').click(function() {
                $('#system-status-summary').fadeOut();
            });
        }

        // Auto-refresh setup for all utilities
        function initializeAutoRefresh() {
            console.log('‚è∞ Initializing auto-refresh for all utilities...');

            // Refresh system status every 5 minutes
            setInterval(function() {
                if (typeof window.refreshSystemStatus === 'function') {
                    window.refreshSystemStatus();
                }
            }, 300000); // 5 minutes

            // Refresh individual utility overviews
            setInterval(function() {
                // Health overview
                if (typeof window.HealthUtility !== 'undefined' && window.HealthUtility.refreshOverview) {
                    window.HealthUtility.refreshOverview();
                }

                // Monitor overview
                if (typeof window.MonitorUtility !== 'undefined' && window.MonitorUtility.refreshOverview) {
                    window.MonitorUtility.refreshOverview();
                }

                // Session overview
                if (typeof window.SessionUtility !== 'undefined' && window.SessionUtility.refreshStatus) {
                    window.SessionUtility.refreshStatus();
                }
            }, 180000); // 3 minutes

            console.log('‚úÖ Auto-refresh initialized for all utilities');
        }

        // Global error handler for utility operations
        window.addEventListener('error', function(event) {
            console.error('Utility Error:', event.error);
            if (typeof window.showToast === 'function') {
                window.showToast('System Error', 'An unexpected error occurred. Check console for details.', 'error');
            }
        });

        // Global utility status checker
        window.checkUtilityStatus = function() {
            const utilities = {
                'Backup Management': typeof window.BackupUtility !== 'undefined',
                'Cache Monitoring': typeof window.MonitorUtility !== 'undefined',
                'Session Diagnostics': typeof window.SessionUtility !== 'undefined',
                'Merge Management': typeof window.MergeUtility !== 'undefined',
                'System Health': typeof window.HealthUtility !== 'undefined',
                'Diagnostics': typeof window.DiagnosticsUtility !== 'undefined',
                'Quick Actions': typeof window.ActionsUtility !== 'undefined',
                'Main Coordinator': typeof window.UtilityMain !== 'undefined'
            };

            const allLoaded = Object.values(utilities).every(Boolean);
            const loadedCount = Object.values(utilities).filter(Boolean).length;
            const totalCount = Object.keys(utilities).length;

            console.log(`üìä Utility Status: ${loadedCount}/${totalCount} loaded`);
            console.table(utilities);

            if (typeof window.showToast === 'function') {
                const message = allLoaded ?
                'All utilities are loaded and ready' :
                `${loadedCount}/${totalCount} utilities loaded`;
                const type = allLoaded ? 'success' : 'warning';
                window.showToast('Utility Status', message, type);
            }

            return utilities;
        };

        console.log('‚úÖ Utility initialization complete');
    </script>
</th:block>